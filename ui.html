<div class="wrapper">
  <button id="load-collections">load collections</button>
  <select id="collections-select"></select>

  <div id="formatting-instructions"></div>
  <textarea id="formatter"></textarea>
  <button id="formatter-submit">Generate</button>

  <div id="current-collection-id"></div>
  <div class="util-buttons-wrapper" id="util-buttons-wrapper">
    <button class="back" id="back">Back</button>
    <button class="copy-all" id="copy-all">Copy to clipboard</button>
  </div>
  <div class="content-wrapper" id="content-wrapper"></div>
</div>

<script>
  document.getElementById('load-collections').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'load-collections' } }, '*')
  }

  document.getElementById('collections-select').onchange = (event) => {
    console.log('EVENT', event.target.value)
    document.getElementById('current-collection-id').innerText = event.target.value
    parent.postMessage({ pluginMessage: { type: 'collection-selected', collectionId: event.target.value } }, '*')
  }

  document.getElementById('formatter-submit').onclick = (event) => {
    const formatterText = document.getElementById('formatter').value
    const collectionId = document.getElementById('current-collection-id').innerText
    document.getElementById('formatting-instructions').style.display = 'none'
    document.getElementById('formatter').style.display = 'none'
    document.getElementById('formatter-submit').style.display = 'none'
    parent.postMessage({ pluginMessage: { type: 'create-mixins', format: formatterText, collectionId } }, '*')
  }

  document.getElementById('copy-all').onclick = () => {
    const textElement = document.getElementById('content-wrapper');

    // Create a temporary text area to hold the text to be copied
    const textArea = document.createElement('textarea');
    textArea.value = textElement.innerText; // Get the text content of the element
    document.body.appendChild(textArea);

    // Select the text in the textarea
    textArea.select();

    // Execute the copy command
    document.execCommand('copy');

    // Remove the temporary textarea
    document.body.removeChild(textArea);

    // Update copy button
    document.getElementById('copy-all').innerText = 'Copied!'
  }

  document.getElementById('back').onclick = () => {
    document.getElementById('util-buttons-wrapper').style.display = 'none'
    document.getElementById('formatting-instructions').style.display = 'none'
    document.getElementById('formatter').style.display = 'none'
    document.getElementById('formatter-submit').style.display = 'none'
    document.getElementById('load-collections').style.display = 'block'
    document.getElementById('collections-select').style.display = 'block'
    document.getElementById('content-wrapper').innerHTML = ''
  }

  window.onmessage = (event) => {
    const messageData = event.data.pluginMessage
    const { type } = messageData
    if (type === 'mixins-created') {
      const { mixins } = messageData

      document.getElementById('util-buttons-wrapper').style.display = 'flex'
      document.getElementById('formatting-instructions').style.display = 'none'
      document.getElementById('formatter').style.display = 'none'
      document.getElementById('formatter-submit').style.display = 'none'
      document.getElementById('content-wrapper').innerHTML = mixins
    }
    else if (type === 'collections-loaded') {
      const { collections } = messageData
      const select = document.getElementById('collections-select')

      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id
        option.innerText = collection.name

        select.appendChild(option)
      })

      console.log('COLLECTIONS', collections)
    }
    else if (type === 'collection-vars-loaded') {
      const { formattingVars } = messageData
      const formattingInstructions = document.getElementById('formatting-instructions')

      const varNamesString = formattingVars
        .map((varName, index) => {
          // Format each item as ${varName}, but leave the last one special with "and"
          return index === formattingVars.length - 1
            ? `and \${${varName}}` // Add "and" before the last item
            : `\${${varName}}`;
        })
        .join(', ')

      formattingInstructions.innerText = `Use ${varNamesString} inside of your format to replace with variable values`

      document.getElementById('formatting-instructions').style.display = 'block'
      document.getElementById('formatter').style.display = 'block'
      document.getElementById('formatter-submit').style.display = 'block'
      document.getElementById('collections-select').style.display = 'none'
      document.getElementById('load-collections').style.display = 'none'

      console.log('FORMATTING VARS', varNamesString)
    }
  }
</script>

<style>
  .wrapper {
    display: flex;
    flex-direction: column;
    gap: 12px;
    justify-content: center;
    min-height: 100%;
  }

  .wrapper button {
    background-color: rgb(11, 37, 114);
    color: white;
    font-weight: bold;
    border-radius: 6px;
    border: none;
    padding: 12px;
    cursor: pointer;
  }

  #current-collection-id {
    display: none;
  }

  .first-line {
    margin-top: 10px;
  }

  .tab-1 {
    padding-left: 16px;
  }

  .tab-2 {
    padding-left: 32px;
  }

  #formatting-instructions {
    display: none;
  }

  #formatter {
    display: none;
    height: 100px;
  }

  #formatter-submit {
    display: none;
  }

  .util-buttons-wrapper {
    display: none;
    justify-content: center;
    gap: 12px;
    margin-top: 16px;
  }

  .content-wrapper {
    display: flex;
    flex-direction: column;
  }

  .spacing-function {
    margin-top: 8px;
  }

  .spacing-value {
    padding-left: 16px;
  }

  .font-styles {
    margin-top: 20px;
  }

  .desktop-font-styles {
    margin-top: 8px;
    padding-left: 16px;
  }

  .mobile-style {
    padding-left: 16px;
  }

  .desktop-style {
    padding-left: 32px;
  }
</style>
